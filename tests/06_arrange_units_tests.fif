#!/usr/bin/env fift -s
"./03_line_up_to_match_tests.fif" include
79730 constant getplayeridx
67958 constant getlocalstoreseed
106679 constant getlocallevelstore
76159 constant getlocations

variable player_idx
variable game_idx
variable locations_per_level
variable locations

{ = test_ret_value } : test
// test # 0 get local idx

-1 <b 1 32 u, b> hashu getplayeridx code updated_storage @ c7 runvmctx 
test_code
drop
1 test

-1 <b 2 32 u, b> hashu getplayeridx code updated_storage @ c7 runvmctx 
test_code
drop 
2 test

-1 <b 9 32 u, b> hashu getplayeridx code updated_storage @ c7 runvmctx 
test_code
drop 
-1 test

// test # 1 get local store
1 getlocalstoreseed code updated_storage @ c7 runvmctx 
test_code
drop
0 test

// test # 2 get local level store
1 1 getlocallevelstore code updated_storage @ c7 runvmctx 
test_code
drop
count 16 test

1 2 getlocallevelstore code updated_storage @ c7 runvmctx 
test_code
drop
count 16 test

1 9 getlocallevelstore code updated_storage @ c7 runvmctx 
test_code
drop 
tuple? 0= test_ret_value

2 2 getlocallevelstore code updated_storage @ c7 runvmctx 
test_code
drop 
tuple? 0= test_ret_value

// test # 3 arrange units

{ <b swap 16 u, swap 16 u, b> <s } : create-location-per-level
{ locations_per_level @ 16 udict!+ not abort"cannot add location to dictionary" locations_per_level ! } : add-location-per-level
{ <b locations_per_level @ dict, b> <s } : create-location
{ locations @ 4 udict!+ not abort"cannot add location to dictionary" locations ! } : add-location

dictnew locations !
dictnew locations_per_level !
10 10 create-location-per-level
15 add-location-per-level
create-location 1 add-location

1 player_idx !
1 game_idx !
<b 0xcceeee 32 u, 0 64 u, player_idx @ 8 u, game_idx @ 8 u, locations @ dict,  b> 
<s int_msg_body !  

1 idx !
send-request


dictnew locations !
dictnew locations_per_level !
10 15 create-location-per-level
7 add-location-per-level
create-location 2 add-location

2 player_idx !
1 game_idx !
<b 0xcceeee 32 u, 0 64 u, player_idx @ 8 u, game_idx @ 8 u, locations @ dict,  b> 
<s int_msg_body !  

2 idx !
send-request

dictnew locations !
dictnew locations_per_level !
10 15 create-location-per-level
63 add-location-per-level
create-location 2 add-location

// test # 4 get locations

1 1 getlocations code updated_storage @ c7 runvmctx 
test_code
drop 
<b swap dict, b> boc>B <b dictnew dict, b> boc>B B= 0= test_ret_value

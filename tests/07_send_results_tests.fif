#!/usr/bin/env fift -s
"./06_arrange_units_tests.fif" include
114624 constant gettemproundresults
113176 constant getplayerscount
80145 constant getunitscount
73106 constant getfinalroundresults
100842 constant getunits

variable boards
variable new_players_state

// test # 0 send one result
{ <b swap 4 u, swap 16 u, swap 16 u, b> <s } : create-board
{ boards @ 4 udict!+ not abort"cannot add location to dictionary" boards ! } : add-board
// gold, level, exp, hp
{ <b swap 8 u, swap 8 u, swap 8 u, swap 8 u, b> <s } : create-updated-player
{ new_players_state @ 4 udict!+ not abort"cannot add location to dictionary" new_players_state ! } : add-updated-player

dictnew boards !
dictnew new_players_state !

// add boards
1 1 0 create-board
1 add-board

1 1 1 create-board
2 add-board

// add player states
0 100 1 3 create-updated-player
1 add-updated-player

90 120 1 3 create-updated-player
2 add-updated-player


1 player_idx !
1 game_idx !
<b 0xddeeee 32 u, 0 64 u, player_idx @ 8 u, game_idx @ 8 u, boards @ dict, new_players_state @ dict, b> 
<s int_msg_body !  

1 idx !
send-request
// test # 1 get result
1 gettemproundresults code updated_storage @ c7 runvmctx 
test_code 
drop
<b swap dict, b> boc>B <b dictnew dict, b> boc>B B= 0= test_ret_value
<b swap dict, b> boc>B <b dictnew dict, b> boc>B B= 0= test_ret_value

// test # 2 send all results
2 player_idx !
<b 0xddeeee 32 u, 0 64 u, player_idx @ 8 u, game_idx @ 8 u, boards @ dict, new_players_state @ dict, b> 
<s int_msg_body !  
2 idx !
send-request

// test # 3 check round results

1 getfinalroundresults code updated_storage @ c7 runvmctx 
test_code 
drop .s
<b swap dict, b> boc>B <b dictnew dict, b> boc>B B= 0= test_ret_value
<b swap dict, b> boc>B <b dictnew dict, b> boc>B B= 0= test_ret_value

// test # 4 check players count

1 getplayerscount code updated_storage @ c7 runvmctx 
test_code 
drop
1 = test_ret_value

// test # 5 check units count

1 1 getunitscount code updated_storage @ c7 runvmctx 
test_code 
drop
15 = test_ret_value

// test # 6 check player units after end 

-1 <b 1 32 u, b> hashu 1 1 getunits code updated_storage @ c7 runvmctx
test_code
drop
1 = test_ret_value
